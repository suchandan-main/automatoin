name: "Demo: Azure Group Management with Approval"

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Action'
        required: true
        type: choice
        options: [add, remove]
      display_name:
        description: 'User Display Name'
        required: true
        type: string
      target_group:
        description: 'Select Group'
        required: true
        type: choice
        options:
          - github-developer
          - github-user
          - github-admin

jobs:
  manage-membership:
    runs-on: ubuntu-latest
    # This line is the magic: it triggers the approval UI if the group is admin
    environment: ${{ github.event.inputs.target_group == 'github-admin' && 'admin-approval' || 'none' }}
    
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve IDs and Execute
        uses: azure/cli@v2
        with:
          inlineScript: |
            # 1. Resolve Group ID
            GROUP_ID=$(az ad group list --filter "displayName eq '${{ github.event.inputs.target_group }}'" --query "[0].id" -o tsv)
            if [ -z "$GROUP_ID" ]; then echo "Group not found"; exit 1; fi

            # 2. Resolve User ID
            USER_ID=$(az ad user list --filter "displayName eq '${{ github.event.inputs.display_name }}'" --query "[0].id" -o tsv)
            if [ -z "$USER_ID" ]; then echo "User not found"; exit 1; fi

            # 3. Perform Operation
            if [ "${{ github.event.inputs.operation }}" == "add" ]; then
              az ad group member add --group "$GROUP_ID" --member-id "$USER_ID"
              echo "Added successfully!"
            else
              az ad group member remove --group "$GROUP_ID" --member-id "$USER_ID"
              echo "Removed successfully!"
            fi
